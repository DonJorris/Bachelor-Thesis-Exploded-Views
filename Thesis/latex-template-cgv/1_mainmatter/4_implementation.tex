\iflanguage{ngerman}
{\chapter{Methoden und Umsetzung}}
{\chapter{Methods and Implementation}}
\label{sec:methods}


In order to explain the developed proposed solutions, this chapter will first conduct a problem analysis, then a theoretical classification of the explosion views, and finally the implemented methods. 
To illustrate the implementation, first the structure of the program is presented, then the individual approaches are introduced, and finally the data set and its change over time are discussed and the surface inspection is demonstrated. %TODO Update this
The problem addressed by this work can be divided into three sub-problems. On the one hand, this is the representation of three-dimensional cells and cell complexes; on the other hand, this is the investigation of ways to avoid occlusion and to use immersive techniques and interactions to enable cell and cell surface exploration.
As mentioned in the introductory chapters, different types of explosion views will be tested and compared in order to solve the problem of occlusion.
Special requirements and restrictions apply in this problem scenario, as both the data set and the use of VR technologies necessitate significant changes to traditional explosion views.

Therefore, the \textbf{structure of the data set }structure of the data set should be explained first. %TODO maybe add picture of XML layout? 
It was generated using the Morpheus program and depicts the development of cells over a predetermined time period.
The individual cells consist of voxels which are arranged in a grid layout. Each cell has additional properties such as a unique ID, a cell center and a population to which the cell belongs, as well as data describing the surface properties. 
A population in this context refers to a cell type with unique propagation properties that can be defined in Morpheus.
Different cell populations form a cell complex which is simulated by Morpheus. 
During the simulation, Morpheus then generates snapshots of the current state of the cell complex at regular intervals. 
These are saved as XML files and form the data set used for the visualization in this work. 
In this way, each snapshot describes a temporal state that precisely defines the arrangement of the individual cells in the form of a list of position and surface property values.
The decisive factor here is that the shape and position of an individual cell can change significantly in the course of the simulation. 
The chosen method of occlusion avoidance must therefore take this into account and the visualization should enable the precise inspection of a single cell at any time.

If one now wants to look at the inner cells of the data set and inspect the interaction of the different populations more closely, this is not possible due to the outer cells that cover them. 
So, occlusion occurs because data is obscured by other foreground data.
As demonstrated by Krisanty's example, using cutting planes is not a suitable method of avoiding this problem while still observing the interaction of individual cells with one another. %TODO reference figure 3.9 and cite=Krisanty_2022

Explosive views are suitable for viewing the complete data set and, in particular, for looking into the interior of a cell complex and for inspecting individual cells in a targeted manner. 
This type of representation translates the individual parts of a model or dataset in such a way that each part is detached from its touching neighbors.
It should be ensured that the original position of each part is recognizable or comprehensible. 
To achieve this, exploded views should follow the conventions and properties outlined by Li et al. in the background chapter. %TODO Reference and link
Exploded views that take these properties into account not only allow for the representation of relative spatial relationships, but also allow the viewer to mentally reconstruct the object being viewed and the arrangement of the individual parts within. 
This is further enhanced when the explosion strength can be adjusted interactively and is therefore a suitable method for the problem at hand.
When drawing or generating an exploded view, the following parameters are of importance and must be specified individually for each exploded object:
\begin{itemize}
	\item \textbf{The canonical axis} of the object, this is the main axis of expansion in which the parts should be exploded to make the mental reconstruction as simple as possible. This depends on many different factors of the object that is being inspected, for mechanical objects this is often related to the assembly order. The definition is more challenging for biological datasets and models. For the dataset at hand, it is not possible to define a clear canonical axis, because the cells change over time and there is no direction in which the propagation of the cells is focused. In this case, it is useful to make the choice of the axis dynamically selectable, as this allows the axis to be adapted to the current state of the cell complex. 
	\item \textbf{The choice of perspective.} Traditional exploded views are often drawn from the side of the object or from slightly above, looking down at the object. An orthographic view is frequently used to better indicate the distance between the individual parts. 
	This is not the case with interactive systems like Li et al.'s, which allow the camera perspective to be adjusted to provide a more realistic representation of the object. %TODO cite=Li_2006
	Because this work focuses on the use of VR technologies, a perspective view should be chosen. 
	Furthermore, the camera viewpoint is determined by the position of the headset and should change as the user moves. 
	The use of VR headsets allows for a much more intuitive exploration of the data set and aids in understanding the object's composition. 
	One issue with this is that it can cause visual clutter because the user's field of vision may be obscured by scattered parts.
	\item \textbf{View dependent exploded views.} Closely related to the choice of perspective in interactive exploded views is the choice of whether the position of the exploded parts depends on the camera perspective or not. 
	This results in two categories for exploded views in interactive systems.
	View-independent exploded views that transform parts along an axis or away from a point and are not affected by the camera.
	This allows for a more thorough inspection of all parts and the entire model. 
	Each part is displayed in such a way that its position within the whole is discernible.
	View-dependent exploded views are the second type.
	Certain parts or points are chosen here that are always visible regardless of the angle from which they are viewed. 
	This allows for a close examination of specific parts.
	Which of these possibilities is the better one for the given data set has to be investigated.
\end{itemize}

Interactive explosion views can be generated in two different ways. 
Either by calculating the final positions of the exploded parts or by defining forces that push the parts apart to create meaningful explosion views.
Calculating the positions gives more control over the exploded view and allows to display the composition order. 
This is more difficult with force-based systems, since the forces would have to be defined so that no elements overlap and no blocking constraints are violated during the explosion. 
Both methods can generate qualitative explosion views, however, an advantage of the force-based method is that the strength of the forces can easily be adjusted at runtime and thus new explosion views can be generated. 
In this work both methods are implemented and compared, for this the program structure and the utilized tools are briefly explained. 

\section{Implementation}

The dataset is visualized and the exploded views are implemented using Unity 2021.3. %TODO link
The Unity-XR-Interaction-Toolkit and the Unity-InputSystem are used for VR support. %TODO link
The universal rendering pipeline is used for more performant and lightweight rendering, allowing for more frames per second on mobile devices at the expense of more advanced rendering effects. %TODO link
An Oculus Quest 2 connected to the computer via Airlink is utilized to test the implementation. %TODO link

At program start the resource folder is checked for valid Morpheus datasets.
For each existing file that contains a time step, the corresponding Xml-file is read and loaded. 
Since each time step contains information about the cell populations and the states of the individual cells, these are loaded one after the other.
For each time step it is checked if a cell with the same ID already exists, if this is not the case a new object is created which represents the cell, stores its properties and contains a mesh for each time step of the cell. 
If a cell object with the same ID already exists, a mesh is generated which visualizes the state of the cell and is attached to the cell object as a child object.
At runtime, only the child objects that depict the current time step are active; all others are deactivated.
A manger class allows switching between the different implementations of the exploded views. 
A detailed class diagram which clarifies the program structure can be found in the appendix. %TODO create this and link it
For this work, four different methods for generating exploded views were implemented.

\subsection{Pointexplosion}
The simplest method to generate an exploded view is to explode from a single point.
The initial position of the cells, which is read from the data set, is used as a reference point $P_o$. 
The user can then place a control point $P_c$ at any position from which the explosion originates. 
The new position of the parts is thus determined by the translation along the linear line, which is defined by the control point and the initial reference point.
The target position $P_t$ is determined for each part $P_i$ by the following formula. 
\begin{equation}
	P_t = P_o + (P_o - P_c) * F_{max}
	\label{eq:pointExpl1}
\end{equation}
Here, $F_{max}$ is a constant factor that describes the maximum explosion distance. At the end the position of the part is determined by interpolating between the reference point $P_o$ and the target point $P_t$ with the user adjustable explosion strength $F_e \in [0, 1]$.
It must be ensured that the points are in the same coordinate system, this is not always the case with my implementation, since the individual parts are child objects of a container object, which allows the data set to be scaled.
To clarify the spatial relations, a further adjustable factor $F_l$ has been added which is scaled with the length of the vector from the control point $P_c$ to the initial position $P_o$. This can be used to amplify the spatial distances and to restrict the view to nearby objects.
The final target position is thus described by the following formula:
\begin{equation}
	\vec{d} = (P_o - P_c) 
	\label{eq:pointExpl2}
\end{equation}
\begin{equation} 
	P_t = P_o + \hat{d} * F_{max} + \vec{d} * F_l * \|d\|
	\label{eq:pointExpl3}
\end{equation}
The point explosion is particularly suitable for selecting parts in a targeted manner and for examining them more closely.
This is a view independent explosion view, because the position of the camera has no effect on the position of the parts. 
However, this method does not take into account any blocking directions and relations. 
Enclosed objects are also not recognized and could remain hidden.
Furthermore, there is no consideration of the canonical axes of an object.
The method is similar to the implementation of the explosion probe by Sonnet et al.\cite{Sonnet_2004} but has no effect radius, so all parts, no matter how far away from the control point, are pushed away.

\subsection{Line explosion}
An expanded exploded view that allows more control is achieved by defining a line and transforming the parts away from that line.
This is achieved by allowing the user to set two control points in space, a line is then drawn between these two control points. 
The first of the control points $P_s$ indicates the starting position of the line, the second point $P_d$ the direction in which the line should progress. 
Now each part is projected onto this axis, if this projection lies in front of the starting point, the part is pushed away from this projection point. 
By moving the control points, it is possible to select which parts of the model will explode from their original position and which will remain rigid. 
Moving the control point that defines the direction of the axis allows the user to create different explosion views.
The projection $P_{proj_i}$ of each part $P_i$ onto the defined line can be calculated by projecting the vector $\vec{d_p}$ that goes from the starting point $P_s$ to the respective part onto the line $\vec{d_{ab}}$ that passes through the two control points. 
The projection point is thus given by the following formula:
\begin{equation}
	P_{proj_i} = P_s + \frac{\langle\vec{d_p},\vec{d_{ab}}\rangle}{\langle\vec{d_{ab}},\vec{d_{ab}}\rangle} * \vec{d_{ab}}
	\label{eq:LineProj}
\end{equation}
The target position sought can then be determined by multiplying the vector $\vec{d_{expl}}$, which runs from the calculated point $P_{proj_i}$ to the reference position of the part, by the explosion strength $F_e$.
In order to enable a targeted determination of the effected parts, only those parts are exploded where the dot product of the vectors $\vec{d_{aProj}}$, which is defined by the starting point of the line $P_s$ and the point $P_{proj_i}$, and the line $\vec{d_{ab}}$ is equal to one.
This allows the user, for example, to explode only half of the parts of the object and leave the remaining parts in their original position to get a better understanding of the object. 
To improve the display and make it suitable for each type of cell, three further customizable factors have been introduced that change the target position of the parts and thus generate different explosion views. 
This makes it possible to customize the shape of the exploded view.
\begin{itemize}
	\item The first factor $F_1$ amplifies the distance between the starting point $P_s$ of the line and the projection point $P_{proj_j}$ of the part. %TODO create picture and link it
	This allows to adjust the length of the body of the exploded view and to clarify the distances between the individual parts.  
	\item The second factor $F_2$ amplifies the strength of explosion of the part based on the distance of the part's projection point to the starting point $P_s$ of the line. 
	This causes a cone shape of the explosive body, i.e. the area where the parts explode.
	\item The third factor $F_3$ adds a constant value to the explosion vector $\vec{d_{expl}}$. 
	This leads to a cylindrical explosion view or can be used to enlarge the explosion in case of a low explosion strength.  
\end{itemize}
By adjusting these three factors, different explosion views can be generated. The different possibilities with the corresponding factors can be seen in Figure .  %TODO add figure and explanation and change this figurenumber
The final calculation of the target point is shown in Figure \ref{fig:LineexplosionCode}.
Again, it must be ensured that all points and directions are in the same coordinate system; this was not taken into account in Figure \ref{fig:LineexplosionCode}. The complete implementation can be found on the GitHub page. %TODO cite github
\begin{figure}[b]
	\begin{lstlisting}
List parts
Position a, b
Float F1, F2, F3

function Explode(float F_e){
	var AB = b - a
	
	foreach(part in parts){
		var d_p = part.position - a
		var proj = a + DotProduct(d_p, AB) / DotProduct(AB, AB) * AB
		
		var d_expl = part.position - proj
		var d_a_proj = proj - a
		
		if(DotProduct(AB, proj) == 1){
			part.targetPosition = part.initalPosition + d_expl.normalized * F3
								+ d_a_proj.magnitude * F1 * d_expl.normalized
								+ d_a_proj * F2
		}
		else
			part.targetPosition = part.initalPosition
		
		//LinearInterpolate(a, b, c) is a function that linearly interpolates from Position a to a Position b, by c
		//so the returned value is a + (b - a) * c
		part.position = LinearInterpolate(part.initialPosition, part.targetPosition, F_e)
	}
}
	\end{lstlisting}
	\caption{This shows a pseudo code implementation of the algorithm used for exploding the parts away from a line.}
	\label{fig:LineexplosionCode}
\end{figure}
The line explosion diagram calculated by this method is also view-independent, since the camera has no influence on the target position of the parts.  
It is also possible to place the line in the canonical axis of the object and thus expand it.  

\subsection{Head mounted line explosion}
This method is based on the same implementation as the line explosion, but extended to make it view dependent. 
The only difference is that the control point $P_d$ which determines the direction of the line is set to be the same as the position of the headset in that frame. 
When the first control point is set within the object, an exploded view is created, allowing the user to look into the object dynamically. 
All parts that are in front of the first control point are automatically moved away. 
A function has also been added that stops updating the position of the point $P_d$, turning the function into the previously described line explosion and allowing the user to view specific parts. 

